---
title: "树莓派直播方案折腾记录"
date: 2026-02-26T00:10:00+08:00
---

树莓派摄像头直播，尝试了多种方案，记录一下。

<!--more-->

### 需求
将树莓派摄像头实时推送到浏览器，要求低延迟。

### 尝试的方案

**1. HLS (HTTP Live Streaming)**
libcamera-vid + ffmpeg 生成 m3u8，延迟 2-5 秒，太高。

**2. MJPEG**
ffmpeg 转码为 Motion JPEG，通过 nginx 或 Python SimpleHTTPServer 推送。
问题：浏览器播放卡顿，体验不佳。

**3. WebRTC (最终方案)**
libcamera-vid → ffmpeg (添加时间戳) → RTSP → mediamtx → WebRTC

```bash
libcamera-vid -t 0 --inline -o - --width 480 --height 270 --framerate 15 \
  | ffmpeg -i - -vf 'drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSansMono-Bold.ttf:text=%{localtime}:fontcolor=white:fontsize=20:x=10:y=10:box=1:boxcolor=black@0.5:boxborderw=5' \
  -c:v libx264 -preset ultrafast -tune zerolatency -b:v 500k \
  -f rtsp rtsp://localhost:8554/stream
```

mediamtx 配置：
- RTSP 端口: 8554
- WebRTC 端口: 8889
- HLS 端口: 8888

### 遇到的坑

1. **摄像头被占用**: libcamera-still 或其他进程占用摄像头，需要 `pkill -f libcamera` 杀掉

2. **ffmpeg 管道写法**: 复杂 filter 需要用单引号包住，避免 shell 转义问题

3. **WebRTC 跨域**: 通过 nginx 反向代理时，直接用 8889 端口访问最稳定

4. **mediamtx API**: 需要在配置中启用 `api: true`

### 延迟测量

最终延迟约 **200-400ms**，通过对比视频内服务器时间戳和客户端时间手动计算。
